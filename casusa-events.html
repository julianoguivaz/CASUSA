<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASUSA Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900">
    <div id="app"></div>

    <script>
        // Armazenamento local
        const storage = {
            get: (key, def = []) => {
                try {
                    return JSON.parse(localStorage.getItem(key)) || def;
                } catch {
                    return def;
                }
            },
            set: (key, val) => {
                try {
                    localStorage.setItem(key, JSON.stringify(val));
                } catch (e) {
                    console.error('Storage error:', e);
                }
            }
        };

        // Sons
        function playSound(type = 'success') {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = type === 'success' ? 'sine' : 'square';
                osc.frequency.setValueAtTime(type === 'success' ? 880 : 220, ctx.currentTime);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) {}
        }

        // Valida√ß√£o
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // QR Code
        function generateQR(data) {
            const url = new URL('https://api.qrserver.com/v1/create-qr-code/');
            url.searchParams.set('size', '256x256');
            url.searchParams.set('data', JSON.stringify(data));
            return url.toString();
        }

        // HTML Helpers
        function html(strings, ...values) {
            let result = '';
            for (let i = 0; i < strings.length; i++) {
                result += strings[i];
                if (i < values.length) {
                    result += values[i];
                }
            }
            return result;
        }

        // App State
        let state = {
            view: 'list',
            events: storage.get('casusa_events', []),
            selectedEvent: null,
            eventToEdit: null,
            guests: {},
            showForms: {}
        };

        // Update
        function setState(updates) {
            state = { ...state, ...updates };
            render();
        }

        // Render
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            const header = document.createElement('header');
            header.className = 'bg-slate-900/80 backdrop-blur border-b border-slate-700 p-4 flex justify-between items-center sticky top-0 z-40';
            header.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 bg-yellow-400 rounded-lg flex items-center justify-center font-bold text-black text-lg">C</div>
                    <span class="font-bold text-xl hidden sm:inline text-white">CASUSA Events</span>
                </div>
                <div class="text-xs text-gray-500">v1.0</div>
            `;
            app.appendChild(header);

            const main = document.createElement('main');
            main.className = 'text-white';

            if (state.view === 'list') {
                main.innerHTML = renderList();
            } else if (state.view === 'detail') {
                main.innerHTML = renderDetail();
            } else if (state.view === 'form') {
                main.innerHTML = renderForm();
            } else if (state.view === 'scanner') {
                main.innerHTML = renderScanner();
            }

            app.appendChild(main);
        }

        function renderList() {
            const events = state.events;
            
            let html = `
                <div class="p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
                        <div>
                            <h1 class="text-4xl font-bold text-white">Eventos CASUSA</h1>
                            <p class="text-gray-400 mt-1">Gerencie eventos e convidados</p>
                        </div>
                        <button onclick="criarEvento()" class="flex items-center gap-2 bg-yellow-400 text-black px-6 py-3 rounded-lg hover:bg-yellow-300 font-bold cursor-pointer">
                            ‚ûï Novo
                        </button>
                    </div>
            `;

            if (events.length === 0) {
                html += `
                    <div class="text-center py-20 bg-slate-800 rounded-xl">
                        <h2 class="text-2xl font-bold text-white mb-2">Sem eventos</h2>
                        <p class="text-gray-400">Clique em "Novo" para criar um evento</p>
                    </div>
                `;
            } else {
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                events.forEach(event => {
                    const data = new Date(event.date);
                    html += `
                        <div class="bg-slate-800 rounded-xl shadow-lg hover:shadow-yellow-400/20 hover:ring-2 hover:ring-yellow-400 cursor-pointer transform hover:-translate-y-1 transition-all" onclick="abrirEvento('${event.id}')">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-white mb-3">${event.name}</h2>
                                <div class="flex items-center gap-2 text-sm text-gray-400 mb-3">üìÖ ${data.toLocaleDateString('pt-BR')}</div>
                                <div class="flex justify-between text-sm text-gray-300">
                                    <div class="flex items-center gap-2">üë• ${event.maxParticipants}</div>
                                    <div class="flex items-center gap-2">üìç ${event.location}</div>
                                </div>
                            </div>
                            <div class="bg-slate-700/50 px-6 py-3 flex justify-end gap-2 rounded-b-xl">
                                <button onclick="editarEvento('${event.id}'); event.stopPropagation();" class="p-2 text-blue-400 hover:bg-slate-600 rounded cursor-pointer border-0 bg-transparent">‚úèÔ∏è</button>
                                <button onclick="deletarEvento('${event.id}'); event.stopPropagation();" class="p-2 text-red-500 hover:bg-slate-600 rounded cursor-pointer border-0 bg-transparent">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function renderForm() {
            const event = state.eventToEdit;
            const isEdit = !!event;
            const date = isEdit ? new Date(event.date).toISOString().split('T')[0] : '';
            const time = isEdit ? event.time : '19:00';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
                    <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
                        <button onclick="voltar()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl cursor-pointer border-0 bg-transparent">‚úï</button>
                        
                        <h2 class="text-3xl font-bold text-yellow-400 mb-6">${isEdit ? 'Editar Evento' : 'Criar Evento'}</h2>

                        <form onsubmit="salvarEvento(event); return false;" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="eventName" placeholder="Nome do Evento" value="${isEdit ? event.name : ''}" class="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 text-white" required />
                                <input type="text" id="eventLocation" placeholder="Local" value="${isEdit ? event.location : ''}" class="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 text-white" required />
                                <input type="date" id="eventDate" value="${date}" class="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 text-white" required />
                                <input type="time" id="eventTime" value="${time}" class="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 text-white" required />
                                <input type="number" id="eventMax" placeholder="N¬∫ Participantes" value="${isEdit ? event.maxParticipants : ''}" min="1" class="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 text-white" required />
                            </div>

                            <div class="flex justify-end gap-4">
                                <button type="button" onclick="voltar()" class="px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-500 cursor-pointer border-0">Cancelar</button>
                                <button type="submit" class="px-6 py-3 rounded-lg bg-yellow-400 text-black hover:bg-yellow-300 font-bold cursor-pointer border-0">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderDetail() {
            const event = state.selectedEvent;
            const guestList = state.guests[event.id] || [];
            const totalRevenue = guestList.reduce((sum, g) => sum + getPrice(g), 0);
            const present = guestList.filter(g => g.checkedIn).length;

            let html = `
                <div class="p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <button onclick="voltar()" class="flex items-center gap-2 text-yellow-400 hover:text-yellow-300 mb-2 cursor-pointer border-0 bg-transparent">‚¨ÖÔ∏è Voltar</button>
                            <h1 class="text-4xl font-bold text-white">${event.name}</h1>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="abrirScanner()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500 cursor-pointer border-0">üì± Check-in</button>
                            <button onclick="editarEvento('${event.id}')" class="p-2 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer border-0">‚úèÔ∏è</button>
                            <button onclick="confirmarDelecao('${event.id}')" class="p-2 bg-red-600 rounded-lg hover:bg-red-500 cursor-pointer border-0">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-white">
                        <div class="bg-slate-800 p-4 rounded-lg">
                            <div class="text-sm"><strong>üìÖ Data:</strong><br/>${new Date(event.date).toLocaleDateString('pt-BR')} √†s ${event.time}</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-lg">
                            <div class="text-sm"><strong>üìç Local:</strong><br/>${event.location}</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-lg">
                            <div class="text-sm"><strong>üë• Convidados:</strong><br/>${guestList.length} / ${event.maxParticipants}</div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-lg">
                            <div class="text-sm"><strong>üíµ Total:</strong><br/>R$ ${totalRevenue.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h3 class="text-2xl font-bold text-yellow-400 mb-2">Convidados</h3>
                            <div class="flex justify-between items-center mb-4 gap-4">
                                <input type="text" id="searchGuest" placeholder="Buscar..." class="w-full max-w-md bg-slate-700 p-3 rounded-lg border border-slate-600 text-white" onkeyup="filtrarConvidados('${event.id}')" />
                                <button onclick="abrirFormConvidado('${event.id}', null)" class="flex items-center gap-2 bg-yellow-400 text-black px-4 py-2 rounded-lg hover:bg-yellow-300 font-bold cursor-pointer border-0 whitespace-nowrap">‚ûï Cadastrar</button>
                            </div>

                            <div class="bg-slate-800 rounded-lg overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-300">
                                    <thead class="bg-slate-700/50">
                                        <tr>
                                            <th class="p-4">Check-in</th>
                                            <th class="p-4">Nome</th>
                                            <th class="p-4">Tipo</th>
                                            <th class="p-4">Mesa</th>
                                            <th class="p-4">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="guestTable">
                                        <!-- Preenchido por JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h3 class="text-2xl font-bold text-yellow-400 mb-4">Relat√≥rio</h3>
                            <p class="text-4xl font-bold text-white mb-2">R$ ${totalRevenue.toFixed(2)}</p>
                            <p class="text-sm text-gray-400">Presentes: ${present}/${guestList.length}</p>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function renderScanner() {
            const event = state.selectedEvent;
            return `
                <div class="p-4 sm:p-6">
                    <button onclick="voltar()" class="flex items-center gap-2 text-yellow-400 hover:text-yellow-300 mb-4 cursor-pointer border-0 bg-transparent">‚¨ÖÔ∏è Voltar</button>
                    <div class="max-w-xl mx-auto bg-slate-800 rounded-xl p-6 shadow-lg">
                        <h2 class="text-2xl font-bold text-white mb-6 text-center">Check-in: ${event.name}</h2>

                        <div class="bg-slate-700 p-8 rounded-lg border-2 border-dashed border-slate-600 text-center mb-6">
                            <div style="font-size: 64px; margin-bottom: 16px;">üì±</div>
                            <p class="text-gray-300">Escaneie o QR Code do convidado</p>
                            <p class="text-gray-500 text-xs mt-2">ou insira o JSON manualmente</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-300 mb-2 block">Cole o conte√∫do do QR Code:</label>
                                <textarea id="qrInput" placeholder='{"eventId":"1","guestId":"guest1"}' class="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 text-white text-sm font-mono h-24"></textarea>
                                <button onclick="procesarQR('${event.id}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg mt-2 cursor-pointer border-0">Processar Check-in</button>
                            </div>
                            <div id="messageBox" class="hidden"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√µes de a√ß√£o
        function criarEvento() {
            setState({ view: 'form', eventToEdit: null });
        }

        function editarEvento(id) {
            const event = state.events.find(e => e.id === id);
            setState({ view: 'form', eventToEdit: event });
        }

        function abrirEvento(id) {
            const event = state.events.find(e => e.id === id);
            state.guests[id] = storage.get(`guests_${id}`, []);
            setState({ view: 'detail', selectedEvent: event });
        }

        function abrirScanner() {
            setState({ view: 'scanner' });
        }

        function voltar() {
            if (state.view === 'detail' || state.view === 'scanner') {
                setState({ view: 'list' });
            } else if (state.view === 'form') {
                setState({ view: 'list', eventToEdit: null });
            }
        }

        function salvarEvento(e) {
            e.preventDefault();

            const name = document.getElementById('eventName').value;
            const location = document.getElementById('eventLocation').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const maxParticipants = parseInt(document.getElementById('eventMax').value);

            if (!name || !location || !date || !time || !maxParticipants) {
                alert('Preencha todos os campos!');
                return;
            }

            const eventData = {
                name,
                location,
                date: new Date(`${date}T${time}`).getTime(),
                time,
                maxParticipants,
                tableCount: Math.ceil(maxParticipants / 8)
            };

            if (state.eventToEdit) {
                const updated = state.events.map(e => e.id === state.eventToEdit.id ? { ...e, ...eventData } : e);
                state.events = updated;
            } else {
                state.events.push({ id: Date.now().toString(), ...eventData });
            }

            storage.set('casusa_events', state.events);
            setState({ view: 'list', eventToEdit: null });
        }

        function confirmarDelecao(id) {
            if (confirm('Tem certeza que deseja deletar este evento?')) {
                state.events = state.events.filter(e => e.id !== id);
                storage.set('casusa_events', state.events);
                storage.set(`guests_${id}`, []);
                setState({ view: 'list' });
            }
        }

        function abrirFormConvidado(eventId, guestId) {
            const event = state.selectedEvent;
            const guestList = state.guests[eventId] || [];
            let guest = null;

            if (guestId) {
                guest = guestList.find(g => g.id === guestId);
            }

            const nome = guest ? guest.fullName : '';
            const mesa = guest ? guest.tableNumber : '1';

            const novoNome = prompt('Nome do convidado:', nome);
            if (novoNome) {
                const novoGuest = {
                    id: guest ? guest.id : Date.now().toString(),
                    fullName: novoNome,
                    tableNumber: mesa,
                    guestType: 'socio',
                    ageGroup: '12+',
                    checkedIn: guest ? guest.checkedIn : false
                };

                if (guest) {
                    state.guests[eventId] = guestList.map(g => g.id === guest.id ? novoGuest : g);
                } else {
                    state.guests[eventId] = [...guestList, novoGuest];
                }

                storage.set(`guests_${eventId}`, state.guests[eventId]);
                render();
                preencherTabela(eventId);
            }
        }

        function getPrice(guest) {
            if (guest.guestType === 'VIP' || guest.ageGroup === '0-5') return 0;
            return 100;
        }

        function procesarQR(eventId) {
            const input = document.getElementById('qrInput').value;
            const guestList = state.guests[eventId] || [];

            try {
                const data = JSON.parse(input);
                const guest = guestList.find(g => g.id === data.guestId);

                if (!guest) {
                    showMessage('Convidado n√£o encontrado', 'error');
                    playSound('error');
                    return;
                }

                if (guest.checkedIn) {
                    showMessage(`${guest.fullName} j√° fez check-in`, 'warning');
                } else {
                    guest.checkedIn = true;
                    state.guests[eventId] = guestList;
                    storage.set(`guests_${eventId}`, guestList);
                    showMessage(`Check-in confirmado: ${guest.fullName}`, 'success');
                    playSound('success');
                }
            } catch (e) {
                showMessage('QR Code inv√°lido', 'error');
                playSound('error');
            }

            document.getElementById('qrInput').value = '';
        }

        function showMessage(text, type) {
            const box = document.getElementById('messageBox');
            const bgColor = type === 'success' ? 'bg-green-500/80' : type === 'warning' ? 'bg-yellow-500/80' : 'bg-red-500/80';
            box.className = `p-4 rounded-lg text-center font-bold text-white ${bgColor}`;
            box.textContent = text;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        function preencherTabela(eventId) {
            const guestList = state.guests[eventId] || [];
            const searchTerm = document.getElementById('searchGuest')?.value || '';
            const filtered = guestList.filter(g => g.fullName.toLowerCase().includes(searchTerm.toLowerCase()));

            const tbody = document.getElementById('guestTable');
            if (!tbody) return;

            tbody.innerHTML = filtered.map(guest => `
                <tr class="border-b border-slate-700 hover:bg-slate-700/50">
                    <td class="p-4 text-center">
                        <button onclick="toggleCheckIn('${eventId}', '${guest.id}')" class="px-3 py-1 rounded text-xs font-bold cursor-pointer border-0 ${guest.checkedIn ? 'bg-green-600 text-white' : 'bg-gray-600 text-white'}">
                            ${guest.checkedIn ? 'Presente' : 'Ausente'}
                        </button>
                    </td>
                    <td class="p-4 text-white">${guest.fullName}</td>
                    <td class="p-4">${guest.guestType}</td>
                    <td class="p-4">${guest.tableNumber}</td>
                    <td class="p-4 flex gap-2">
                        <button onclick="abrirFormConvidado('${eventId}', '${guest.id}')" class="text-blue-400 hover:text-blue-300 cursor-pointer border-0 bg-transparent">‚úèÔ∏è</button>
                        <button onclick="deletarConvidado('${eventId}', '${guest.id}')" class="text-red-500 hover:text-red-400 cursor-pointer border-0 bg-transparent">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleCheckIn(eventId, guestId) {
            const guestList = state.guests[eventId] || [];
            const guest = guestList.find(g => g.id === guestId);
            if (guest) {
                guest.checkedIn = !guest.checkedIn;
                state.guests[eventId] = guestList;
                storage.set(`guests_${eventId}`, guestList);
                preencherTabela(eventId);
                playSound('success');
            }
        }

        function deletarConvidado(eventId, guestId) {
            if (confirm('Deletar convidado?')) {
                state.guests[eventId] = (state.guests[eventId] || []).filter(g => g.id !== guestId);
                storage.set(`guests_${eventId}`, state.guests[eventId]);
                preencherTabela(eventId);
            }
        }

        function filtrarConvidados(eventId) {
            preencherTabela(eventId);
        }

        // Iniciar
        render();
    </script>
</body>
</html>
