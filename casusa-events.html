import React, { useState, useEffect, useMemo, useRef, useReducer } from 'react';
import { Plus, Edit, Trash2, Users, Calendar, MapPin, Clock, DollarSign, FileText, ArrowLeft, UserCheck, X, QrCode, CheckCircle2, XCircle, Mail, Upload, Search, AlertCircle } from 'lucide-react';

// --- MOCK DATA (substituir por Firebase depois) ---
const MOCK_EVENTS = [
  {
    id: '1',
    name: 'Jantar CASUSA 2024',
    date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
    time: '19:30',
    location: 'Clube Militar',
    maxParticipants: 200,
    tableCount: 25,
    pricing: {
      '6-12': { socio: 50, dependente: 40, 'nao-socio': 60 },
      '12+': { socio: 100, dependente: 80, 'nao-socio': 120 },
      'convite-especial': { description: 'VIP', price: 0 }
    },
    userId: 'user1'
  }
];

const MOCK_GUESTS = [
  {
    id: 'guest1',
    eventId: '1',
    fullName: 'João Silva',
    callSign: 'Falcão',
    phone: '11999999999',
    email: 'joao@email.com',
    saram: '12345',
    postoGrad: 'TEN',
    ageGroup: '12+',
    guestType: 'socio',
    tableNumber: '1',
    checkedIn: false,
    userId: 'user1'
  }
];

// --- UTILITÁRIOS ---
const playSound = (type = 'success') => {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (!audioContext) return;
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    if (type === 'success') {
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
    } else {
      oscillator.type = 'square';
      oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
    }

    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
  } catch (e) {
    console.error('Audio error:', e);
  }
};

const validateEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

// --- COMPONENTES DE UI ---
const Spinner = () => (
  <div className="flex justify-center items-center h-32">
    <div className="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-yellow-400"></div>
  </div>
);

const Modal = ({ children, onClose }) => (
  <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
    <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 relative">
      <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white">
        <X size={24} />
      </button>
      {children}
    </div>
  </div>
);

const ConfirmationModal = ({ title, message, onConfirm, onCancel }) => (
  <Modal onClose={onCancel}>
    <div className="text-white">
      <h2 className="text-2xl font-bold mb-4 text-yellow-400">{title}</h2>
      <p className="mb-6 text-gray-300">{message}</p>
      <div className="flex justify-end gap-4">
        <button onClick={onCancel} className="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
        <button onClick={onConfirm} className="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-500 font-semibold">Confirmar</button>
      </div>
    </div>
  </Modal>
);

const QRCodeModal = ({ guest, event, onClose }) => {
  const qrCodeRef = useRef(null);

  useEffect(() => {
    if (qrCodeRef.current && window.QRious) {
      new window.QRious({
        element: qrCodeRef.current,
        value: JSON.stringify({ eventId: event.id, guestId: guest.id }),
        size: 256,
        level: 'H'
      });
    }
  }, [guest, event]);

  return (
    <Modal onClose={onClose}>
      <div className="text-center text-white p-4">
        <h2 className="text-2xl font-bold text-yellow-400 mb-2">QR Code de Check-in</h2>
        <p className="text-lg mb-1">{guest.fullName}</p>
        <p className="text-sm text-gray-400 mb-6">{event.name}</p>
        <div className="flex justify-center bg-white p-4 rounded-lg">
          <canvas ref={qrCodeRef}></canvas>
        </div>
      </div>
    </Modal>
  );
};

// --- FORMULÁRIOS ---
const EventForm = ({ onSave, onClose, eventToEdit }) => {
  const initialPricing = {
    '6-12': { socio: 0, dependente: 0, 'nao-socio': 0 },
    '12+': { socio: 0, dependente: 0, 'nao-socio': 0 },
    'convite-especial': { description: '', price: 0 }
  };

  const [eventData, setEventData] = useState({
    name: '', date: '', time: '', location: '', maxParticipants: '', pricing: initialPricing,
  });
  const [error, setError] = useState('');

  useEffect(() => {
    if (eventToEdit) {
      setEventData({
        name: eventToEdit.name || '',
        date: eventToEdit.date ? eventToEdit.date.toISOString().split('T')[0] : '',
        time: eventToEdit.time || '',
        location: eventToEdit.location || '',
        maxParticipants: eventToEdit.maxParticipants || '',
        pricing: eventToEdit.pricing || initialPricing,
      });
    }
  }, [eventToEdit]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setEventData(prev => ({ ...prev, [name]: value }));
  };

  const handlePriceChange = (ageGroup, guestType, value) => {
    setEventData(prev => ({
      ...prev,
      pricing: { ...prev.pricing, [ageGroup]: { ...prev.pricing[ageGroup], [guestType]: parseFloat(value) || 0 } },
    }));
  };

  const handleSpecialInviteChange = (field, value) => {
    setEventData(prev => ({
      ...prev,
      pricing: {
        ...prev.pricing,
        'convite-especial': {
          ...prev.pricing['convite-especial'],
          [field]: field === 'price' ? parseFloat(value) || 0 : value,
        },
      },
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    setError('');

    if (!eventData.name || !eventData.date || !eventData.time || !eventData.maxParticipants) {
      setError('Preencha todos os campos obrigatórios.');
      return;
    }

    const maxParticipants = parseInt(eventData.maxParticipants, 10);
    if (maxParticipants < 1) {
      setError('Número de participantes deve ser maior que 0.');
      return;
    }

    const tableCount = Math.ceil(maxParticipants / 8);
    const submissionData = {
      ...eventData,
      maxParticipants,
      date: new Date(`${eventData.date}T${eventData.time}`),
      tableCount,
    };
    onSave(submissionData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6 text-white">
      <h2 className="text-3xl font-bold text-yellow-400">{eventToEdit ? 'Editar Evento' : 'Criar Novo Evento'}</h2>
      {error && <p className="text-red-400 bg-red-900/50 p-3 rounded-lg">{error}</p>}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <label className="font-semibold text-gray-300">Nome do Evento</label>
          <input type="text" name="name" value={eventData.name} onChange={handleChange} className="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" required />
        </div>
        <div className="space-y-2">
          <label className="font-semibold text-gray-300">Local</label>
          <input type="text" name="location" value={eventData.location} onChange={handleChange} className="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" required />
        </div>
        <div className="space-y-2">
          <label className="font-semibold text-gray-300">Data</label>
          <input type="date" name="date" value={eventData.date} onChange={handleChange} className="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" required />
        </div>
        <div className="space-y-2">
          <label className="font-semibold text-gray-300">Hora</label>
          <input type="time" name="time" value={eventData.time} onChange={handleChange} className="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" required />
        </div>
        <div className="space-y-2">
          <label className="font-semibold text-gray-300">Nº Participantes</label>
          <input type="number" name="maxParticipants" value={eventData.maxParticipants} onChange={handleChange} min="1" className="w-full bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" required />
        </div>
      </div>

      <div className="space-y-4 pt-4 border-t border-slate-700">
        <h3 className="text-xl font-bold text-yellow-400">Definição de Preços</h3>
        {['6-12', '12+'].map(ag => (
          <div key={ag} className="p-4 bg-slate-700/50 rounded-lg">
            <h4 className="font-semibold text-lg mb-2">{ag === '12+' ? 'Acima de 12 anos' : `${ag} anos`}</h4>
            <div className="grid grid-cols-3 gap-4">
              {['socio', 'dependente', 'nao-socio'].map(gt => (
                <div key={gt} className="space-y-1">
                  <label className="capitalize text-sm text-gray-300">{gt.replace('-', ' ')}</label>
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">R$</span>
                    <input type="number" step="0.01" value={eventData.pricing[ag]?.[gt] || 0} onChange={(e) => handlePriceChange(ag, gt, e.target.value)} className="w-full bg-slate-600 p-2 pl-9 rounded-md border border-slate-500 focus:ring-2 focus:ring-yellow-400 focus:outline-none" />
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      <div className="flex justify-end gap-4 pt-6">
        <button type="button" onClick={onClose} className="px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
        <button type="submit" className="px-6 py-3 rounded-lg bg-yellow-400 text-black hover:bg-yellow-300 font-bold flex items-center gap-2"><UserCheck size={20}/>{eventToEdit ? 'Salvar' : 'Criar'}</button>
      </div>
    </form>
  );
};

const GuestForm = ({ event, guests, onSave, onClose, guestToEdit }) => {
  const [guestData, setGuestData] = useState({
    fullName: '', callSign: '', phone: '', email: '', saram: '', postoGrad: '', ageGroup: '0-5', guestType: 'socio', tableNumber: '1'
  });
  const [error, setError] = useState('');

  useEffect(() => {
    if (guestToEdit) {
      setGuestData(guestToEdit);
    }
  }, [guestToEdit]);

  const handleChange = (e) => {
    let { name, value } = e.target;
    if (name === 'postoGrad') value = value.toUpperCase();
    setGuestData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    setError('');

    if (!guestData.fullName) {
      setError('Nome completo é obrigatório.');
      return;
    }

    if (guestData.email && !validateEmail(guestData.email)) {
      setError('Email inválido.');
      return;
    }

    const guestsAtTable = guests.filter(g => g.tableNumber.toString() === guestData.tableNumber.toString() && (!guestToEdit || g.id !== guestToEdit.id)).length;
    if (guestsAtTable >= 8) {
      setError(`Mesa ${guestData.tableNumber} já está cheia.`);
      return;
    }

    if (!guestToEdit && event.maxParticipants <= guests.length) {
      setError('Número máximo de participantes atingido.');
      return;
    }

    onSave(guestData);
  };

  const tableOptions = Array.from({ length: event.tableCount }, (_, i) => i + 1);

  return (
    <form onSubmit={handleSubmit} className="space-y-4 text-white">
      <h2 className="text-3xl font-bold text-yellow-400 mb-6">{guestToEdit ? 'Editar Convidado' : 'Cadastrar Convidado'}</h2>
      {error && <p className="text-red-400 bg-red-900/50 p-3 rounded-lg">{error}</p>}

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" name="fullName" placeholder="Nome Completo" value={guestData.fullName} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" required />
        <input type="text" name="postoGrad" placeholder="P/G (ex: TEN)" value={guestData.postoGrad} onChange={handleChange} maxLength="2" className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" />
        <input type="text" name="callSign" placeholder="Nome de Guerra" value={guestData.callSign} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" />
        <input type="tel" name="phone" placeholder="Telefone" value={guestData.phone} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" />
        <input type="email" name="email" placeholder="Email" value={guestData.email} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" />
        <input type="text" name="saram" placeholder="Nº SARAM" value={guestData.saram} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none" />
        <select name="ageGroup" value={guestData.ageGroup} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none">
          <option value="0-5">0-5 anos</option>
          <option value="6-12">6-12 anos</option>
          <option value="12+">Acima de 12 anos</option>
        </select>
        <select name="guestType" value={guestData.guestType} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none">
          <option value="socio">Sócio</option>
          <option value="dependente">Dependente</option>
          <option value="nao-socio">Não-sócio</option>
          <option value="VIP">VIP</option>
        </select>
        <select name="tableNumber" value={guestData.tableNumber} onChange={handleChange} className="bg-slate-700 p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none">
          {tableOptions.map(t => <option key={t} value={t}>Mesa {t}</option>)}
        </select>
      </div>

      <div className="flex justify-end gap-4 pt-6">
        <button type="button" onClick={onClose} className="px-6 py-3 rounded-lg bg-gray-600 hover:bg-gray-500">Cancelar</button>
        <button type="submit" className="px-6 py-3 rounded-lg bg-yellow-400 text-black hover:bg-yellow-300 font-bold"><UserCheck size={20}/> {guestToEdit ? 'Salvar' : 'Adicionar'}</button>
      </div>
    </form>
  );
};

// --- VIEWS ---
const EventDetailView = ({ event, onBack, onEditEvent, onDeleteEvent, userId, onStartCheckIn }) => {
  const [guests, setGuests] = useState(MOCK_GUESTS.filter(g => g.eventId === event.id));
  const [showGuestForm, setShowGuestForm] = useState(false);
  const [guestToEdit, setGuestToEdit] = useState(null);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
  const [activeTab, setActiveTab] = useState('guests');
  const [showQRCode, setShowQRCode] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');

  const handleSaveGuest = (guestData) => {
    if (guestToEdit) {
      setGuests(guests.map(g => g.id === guestToEdit.id ? { ...g, ...guestData } : g));
    } else {
      setGuests([...guests, { id: Date.now().toString(), eventId: event.id, ...guestData, checkedIn: false, userId }]);
    }
    setShowGuestForm(false);
    setGuestToEdit(null);
  };

  const handleDeleteGuest = (guestId) => {
    setGuests(guests.filter(g => g.id !== guestId));
    setShowDeleteConfirm(null);
  };

  const handleManualCheckIn = (guestId, checkIn) => {
    setGuests(guests.map(g => g.id === guestId ? { ...g, checkedIn: checkIn } : g));
    playSound(checkIn ? 'success' : 'error');
  };

  const getGuestPrice = (guest) => {
    if (guest.guestType === 'VIP' || guest.ageGroup === '0-5') return 0;
    const ageGroupKey = guest.ageGroup === '6-12' ? '6-12' : '12+';
    const priceKey = guest.guestType.replace('-', '');
    return event.pricing?.[ageGroupKey]?.[priceKey] || 0;
  };

  const filteredGuests = useMemo(() => {
    if (!searchTerm) return guests;
    return guests.filter(g => g.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || g.callSign?.toLowerCase().includes(searchTerm.toLowerCase()));
  }, [searchTerm, guests]);

  const reportData = useMemo(() => {
    const totalRevenue = guests.reduce((acc, g) => acc + getGuestPrice(g), 0);
    const guestsByTable = guests.reduce((acc, g) => {
      if (!acc[g.tableNumber]) acc[g.tableNumber] = [];
      acc[g.tableNumber].push(g);
      return acc;
    }, {});
    return { totalRevenue, guestsByTable };
  }, [guests]);

  return (
    <div className="p-4 sm:p-6 md:p-8">
      {showGuestForm && <Modal onClose={() => { setShowGuestForm(false); setGuestToEdit(null); }}><GuestForm event={event} guests={guests} onSave={handleSaveGuest} onClose={() => { setShowGuestForm(false); setGuestToEdit(null); }} guestToEdit={guestToEdit} /></Modal>}
      {showDeleteConfirm && <ConfirmationModal title={typeof showDeleteConfirm === 'string' && showDeleteConfirm.startsWith('guest') ? 'Excluir Convidado?' : 'Excluir Evento?'} message="Esta ação é irreversível." onConfirm={() => typeof showDeleteConfirm === 'string' && showDeleteConfirm.startsWith('guest') ? handleDeleteGuest(showDeleteConfirm) : onDeleteEvent(event.id)} onCancel={() => setShowDeleteConfirm(null)} />}
      {showQRCode && <QRCodeModal guest={showQRCode} event={event} onClose={() => setShowQRCode(null)} />}

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
          <button onClick={onBack} className="flex items-center gap-2 text-yellow-400 hover:text-yellow-300 mb-2"><ArrowLeft size={20} /> Voltar</button>
          <h1 className="text-3xl sm:text-4xl font-bold text-white">{event.name}</h1>
        </div>
        <div className="flex gap-2">
          <button onClick={() => onStartCheckIn(event)} className="flex items-center gap-2 bg-blue-600 text-white font-bold px-4 py-2 rounded-lg hover:bg-blue-500"><QrCode size={18} /> Check-in</button>
          <button onClick={() => onEditEvent(event)} className="p-2 bg-slate-600 rounded-lg hover:bg-slate-500 text-white"><Edit size={20}/></button>
          <button onClick={() => setShowDeleteConfirm('event')} className="p-2 bg-red-600 rounded-lg hover:bg-red-500 text-white"><Trash2 size={20}/></button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-white">
        <div className="bg-slate-800 p-4 rounded-lg"><Calendar className="text-yellow-400 mb-2" size={24}/><div className="text-sm"><strong>Data:</strong><br/>{event.date.toLocaleDateString('pt-BR')} às {event.time}</div></div>
        <div className="bg-slate-800 p-4 rounded-lg"><MapPin className="text-yellow-400 mb-2" size={24}/><div className="text-sm"><strong>Local:</strong><br/>{event.location}</div></div>
        <div className="bg-slate-800 p-4 rounded-lg"><Users className="text-yellow-400 mb-2" size={24}/><div className="text-sm"><strong>Convidados:</strong><br/>{guests.length} / {event.maxParticipants}</div></div>
        <div className="bg-slate-800 p-4 rounded-lg"><DollarSign className="text-yellow-400 mb-2" size={24}/><div className="text-sm"><strong>Mesas:</strong><br/>{event.tableCount}</div></div>
      </div>

      <div className="flex justify-between items-center border-b border-slate-700 mb-6">
        <div className="flex">
          <button onClick={() => setActiveTab('guests')} className={`px-4 py-3 font-semibold transition-colors ${activeTab === 'guests' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400 hover:text-white'}`}>Convidados</button>
          <button onClick={() => setActiveTab('report')} className={`px-4 py-3 font-semibold transition-colors ${activeTab === 'report' ? 'text-yellow-400 border-b-2 border-yellow-400' : 'text-gray-400 hover:text-white'}`}>Relatório</button>
        </div>
      </div>

      {activeTab === 'guests' && (
        <div>
          <div className="flex justify-between items-center mb-4 gap-4">
            <div className="relative w-full max-w-md">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
              <input type="text" placeholder="Buscar nome ou apelido..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-slate-700 p-3 pl-10 rounded-lg border border-slate-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none text-white" />
            </div>
            <button onClick={() => { setGuestToEdit(null); setShowGuestForm(true); }} className="flex-shrink-0 flex items-center gap-2 bg-yellow-400 text-black font-bold px-4 py-2 rounded-lg hover:bg-yellow-300"><Plus size={20}/> Cadastrar</button>
          </div>
          <div className="bg-slate-800 rounded-lg overflow-x-auto">
            <table className="w-full text-left text-sm text-gray-300">
              <thead className="bg-slate-700/50 text-xs text-gray-400 uppercase"><tr><th className="p-4">Check-in</th><th className="p-4">Nome</th><th className="p-4">Tipo</th><th className="p-4">Mesa</th><th className="p-4">Ações</th></tr></thead>
              <tbody>
                {filteredGuests.length > 0 ? filteredGuests.map(guest => (
                  <tr key={guest.id} className="border-b border-slate-700 hover:bg-slate-700/50">
                    <td className="p-4 text-center">
                      {guest.checkedIn ? <span className="text-green-400 flex items-center justify-center gap-2"><CheckCircle2 size={18}/></span> : <button onClick={() => handleManualCheckIn(guest.id, true)} className="bg-green-600 text-white px-3 py-1 rounded text-xs">Confirmar</button>}
                    </td>
                    <td className="p-4 font-medium text-white">{guest.fullName}</td>
                    <td className="p-4 capitalize">{guest.guestType}</td>
                    <td className="p-4">{guest.tableNumber}</td>
                    <td className="p-4 flex gap-2">
                      <button onClick={() => setShowQRCode(guest)} className="p-2 text-gray-400 hover:text-white"><QrCode size={18}/></button>
                      <button onClick={() => { setGuestToEdit(guest); setShowGuestForm(true); }} className="p-2 text-blue-400 hover:text-blue-300"><Edit size={18}/></button>
                      <button onClick={() => setShowDeleteConfirm(guest.id)} className="p-2 text-red-500 hover:text-red-400"><Trash2 size={18}/></button>
                    </td>
                  </tr>
                )) : (<tr><td colSpan="5" className="text-center p-8 text-gray-400">Nenhum convidado encontrado.</td></tr>)}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {activeTab === 'report' && (
